# name: test/sql/html_force_list.test
# description: Test force_list parameter for read_html (feature parity with read_xml)
# group: [sql]

require webbed

# Test 1: Without force_list - discard attributes to focus on structure
query TTTTTT
DESCRIBE SELECT * FROM read_html('test/html/force_list_test.html', record_element:='article', attr_mode:='discard');
----
header	STRUCT(h2 VARCHAR, span VARCHAR)	YES	NULL	NULL	NULL
section	STRUCT("custom-tag" VARCHAR[])	YES	NULL	NULL	NULL

# Test 2: Verify the first record has single tag as array (due to repeated elements fix)
query II
SELECT
    header.span as id,
    section."custom-tag" as tags
FROM read_html('test/html/force_list_test.html', record_element:='article', attr_mode:='discard')
WHERE header.span = '1';
----
1	[important]

# Test 3: Verify second record with multiple tags
query II
SELECT
    header.span as id,
    array_length(section."custom-tag") as tag_count
FROM read_html('test/html/force_list_test.html', record_element:='article', attr_mode:='discard')
WHERE header.span = '2';
----
2	2

# Test 4: Use force_list to ensure section is always a LIST
query T
SELECT typeof(section)
FROM read_html('test/html/force_list_test.html', record_element:='article', attr_mode:='discard', force_list:='section')
LIMIT 1;
----
STRUCT("custom-tag" VARCHAR[])[]

# Test 5: Verify force_list with XPath-style selector
query I
SELECT count(*)
FROM read_html('test/html/force_list_test.html', record_element:='article', attr_mode:='discard', force_list:='//custom-tag');
----
3

# Test 6: Test force_list with array of element names
query T
SELECT typeof(header)
FROM read_html('test/html/force_list_test.html', record_element:='article', attr_mode:='discard', force_list:=['header', 'section'])
LIMIT 1;
----
STRUCT(h2 VARCHAR, span VARCHAR)[]

# Test 7: Verify unnesting works with repeated custom-tag elements
query I
SELECT unnest(section."custom-tag") as tag
FROM read_html('test/html/force_list_test.html', record_element:='article', attr_mode:='discard')
WHERE header.span = '3'
ORDER BY tag;
----
backlog
documentation
research
